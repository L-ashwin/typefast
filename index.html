<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TypeFast</title>
    <style>
        header{
            height: 20vh;
        }

        main{
            margin: auto;
            width: 60vh;
            text-align: center;
        }

        .container {
            padding: 10px;
            margin: 10px;
            background-color:aliceblue;
           
        }

        .text {
            text-align: left;
            font-size: 20pt;
        }

        textarea {
            font-size: 22px;
            width: 80%;
        
        }
    </style>
</head>
<body>
    <header>
        <p id="wpm">speed</p>
    </header>
    <main>
        <div class="container">
            <div class="text">
                <p  id="sourceText">Every man had to die. He'd always found it odd that so many died when they were old, as logic said that was the point in their lives when they'd had the most practice not dying.</p>
            </div>
            <div class="input">
                <textarea name="type" id="userInput" autocomplete="off" rows="1"></textarea>
            </div>
        </div>
        <div class="buttons">
            <button id="clickButton" onclick="startTyping()" autofocus>Start!</button>
            <button id="reStart" onclick="refreshPage()">Refresh Page</button>
        </div>
    </main>
    <footer></footer>

    <script>
        var startTime;
        var sourceTextElement = document.getElementById("sourceText");
        const sourceText = sourceTextElement.textContent;

        function refreshPage() {
            console.log('reload')
            location.reload();
        }

        function startTyping(){
            document.getElementById("userInput").focus();
            startTime = new Date();
        }
        
        var position = 0, newPosition = 0; // till position-1 is already checked & correct
        document.getElementById("userInput").addEventListener("keyup", function(event) {
            var userInputElement = document.getElementById("userInput");
            var userInput = userInputElement.value;
            var userInputLength = userInput.length;
            position = newPosition;
            
            for (var i = 0; i < userInputLength; i++) {
                if(userInput[i] != sourceText[position+i]) {
                    break; //mistake at position + i 
                }
            } // i will be userInputLength if there's no mistake

            var formattedText = "<span style='color: green;'>" + sourceText.substring(0, position+i) + "</span>";
            var mistakesText = "<span style='color: red; background-color:pink'>" + sourceText.substring(position+i, position+userInputLength) + "</span>";
            var remainingText = sourceText.substring(position+userInputLength, sourceText.length) // remaining text
            sourceTextElement.innerHTML = formattedText + mistakesText + remainingText;
            
            // after each word
            if ((userInput[userInputLength-1]==' ') && ( i == userInputLength)){
                newPosition = position+userInputLength;
                userInputElement.value = '';

                var endTime = new Date();
                var wpm = (newPosition/5)/((endTime - startTime)/(1000*60));
                document.getElementById("wpm").textContent = Math.round(wpm);
            }

            // end
            if (sourceText.length==position+i) {
                var endTime = new Date();
                var wpm = (sourceText.length/5)/((endTime - startTime)/(1000*60));
                document.getElementById("wpm").textContent = Math.round(wpm);

                console.log('end!');
                document.getElementById("reStart").focus();
            }
        });


    </script>
</body>
</html>